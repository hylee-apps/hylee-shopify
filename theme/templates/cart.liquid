{% comment %}
  Cart Template
  Full-page shopping cart
{% endcomment %}

<div class="cart-page">
  <div class="cart-page__container">
    
    <div class="cart-page__header">
      <h1 class="cart-page__title">Shopping Cart</h1>
      {% if cart.item_count > 0 %}
        <p class="cart-page__count">{{ cart.item_count }} {% if cart.item_count == 1 %}item{% else %}items{% endif %}</p>
      {% endif %}
    </div>

    {% if cart.item_count > 0 %}
      
      <div class="cart-page__content">
        
        <div class="cart-page__items">
          <form action="{{ routes.cart_url }}" method="post" novalidate>
            
            <div class="cart-items">
              {% for item in cart.items %}
                <div class="cart-item" data-line-item="{{ forloop.index }}">
                  
                  <div class="cart-item__image">
                    {% if item.image %}
                      <img
                        src="{{ item.image | image_url: width: 200 }}"
                        alt="{{ item.image.alt | default: item.product.title }}"
                        loading="lazy"
                        width="200"
                        height="200"
                      >
                    {% else %}
                      <div class="cart-item__placeholder">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                          <circle cx="8.5" cy="8.5" r="1.5"></circle>
                          <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                      </div>
                    {% endif %}
                  </div>

                  <div class="cart-item__details">
                    <div class="cart-item__header">
                      <a href="{{ item.url }}" class="cart-item__title">{{ item.product.title }}</a>
                      {% if item.product.vendor %}
                        <p class="cart-item__vendor">{{ item.product.vendor }}</p>
                      {% endif %}
                    </div>

                    {% unless item.product.has_only_default_variant %}
                      <div class="cart-item__variants">
                        {% for option in item.options_with_values %}
                          <p class="cart-item__variant">
                            <span class="cart-item__variant-name">{{ option.name }}:</span>
                            <span class="cart-item__variant-value">{{ option.value }}</span>
                          </p>
                        {% endfor %}
                      </div>
                    {% endunless %}

                    {% if item.properties.size > 0 %}
                      <div class="cart-item__properties">
                        {% for property in item.properties %}
                          {% unless property.first contains '_' %}
                            <p class="cart-item__property">
                              <span class="cart-item__property-name">{{ property.first }}:</span>
                              <span class="cart-item__property-value">{{ property.last }}</span>
                            </p>
                          {% endunless %}
                        {% endfor %}
                      </div>
                    {% endif %}

                    <div class="cart-item__actions">
                      <div class="cart-item__quantity">
                        <label for="quantity-{{ forloop.index }}" class="visually-hidden">Quantity</label>
                        <button
                          type="button"
                          class="cart-item__quantity-btn"
                          onclick="updateQuantity({{ forloop.index }}, {{ item.quantity | minus: 1 }})"
                          {% if item.quantity <= 1 %}disabled{% endif %}
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                        </button>
                        
                        <input
                          type="number"
                          id="quantity-{{ forloop.index }}"
                          name="updates[]"
                          value="{{ item.quantity }}"
                          min="0"
                          class="cart-item__quantity-input"
                          data-index="{{ forloop.index }}"
                          onchange="updateQuantity({{ forloop.index }}, this.value)"
                        >
                        
                        <button
                          type="button"
                          class="cart-item__quantity-btn"
                          onclick="updateQuantity({{ forloop.index }}, {{ item.quantity | plus: 1 }})"
                        >
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                          </svg>
                        </button>
                      </div>

                      <button
                        type="button"
                        class="cart-item__remove"
                        onclick="updateQuantity({{ forloop.index }}, 0)"
                      >
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="3 6 5 6 21 6"></polyline>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Remove
                      </button>
                    </div>
                  </div>

                  <div class="cart-item__pricing">
                    {% if item.original_price != item.final_price %}
                      <p class="cart-item__price cart-item__price--sale">
                        {{ item.final_price | money }}
                      </p>
                      <p class="cart-item__price cart-item__price--compare">
                        {{ item.original_price | money }}
                      </p>
                    {% else %}
                      <p class="cart-item__price">
                        {{ item.final_price | money }}
                      </p>
                    {% endif %}

                    {% if item.quantity > 1 %}
                      <p class="cart-item__total">
                        Total: {{ item.final_line_price | money }}
                      </p>
                    {% endif %}

                    {% if item.line_level_discount_allocations.size > 0 %}
                      <div class="cart-item__discounts">
                        {% for discount in item.line_level_discount_allocations %}
                          <p class="cart-item__discount">
                            {{ discount.discount_application.title }} (-{{ discount.amount | money }})
                          </p>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>

                </div>
              {% endfor %}
            </div>

          </form>
        </div>

        <div class="cart-page__summary">
          <div class="cart-summary">
            <h2 class="cart-summary__title">Order Summary</h2>

            <div class="cart-summary__line">
              <span>Subtotal ({{ cart.item_count }} items)</span>
              <span>{{ cart.total_price | money }}</span>
            </div>

            {% if cart.cart_level_discount_applications.size > 0 %}
              <div class="cart-summary__discounts">
                {% for discount in cart.cart_level_discount_applications %}
                  <div class="cart-summary__line cart-summary__line--discount">
                    <span>{{ discount.title }}</span>
                    <span>-{{ discount.total_allocated_amount | money }}</span>
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            {% if cart.original_total_price != cart.total_price %}
              <div class="cart-summary__line cart-summary__line--savings">
                <span>Total Savings</span>
                <span>-{{ cart.original_total_price | minus: cart.total_price | money }}</span>
              </div>
            {% endif %}

            <div class="cart-summary__line cart-summary__line--note">
              <span>Shipping</span>
              <span>Calculated at checkout</span>
            </div>

            <div class="cart-summary__line cart-summary__line--total">
              <span>Total</span>
              <span>{{ cart.total_price | money }}</span>
            </div>

            {% if cart.note != blank or true %}
              <div class="cart-summary__note">
                <label for="cart-note" class="cart-summary__note-label">Order Notes (Optional)</label>
                <textarea
                  id="cart-note"
                  name="note"
                  class="cart-summary__note-input"
                  rows="3"
                  placeholder="Special instructions for your order..."
                >{{ cart.note }}</textarea>
              </div>
            {% endif %}

            {% render 'button',
              text: 'Proceed to Checkout',
              url: routes.cart_url,
              variant: 'primary',
              size: 'lg',
              full_width: true,
              attributes: 'name="checkout"'
            %}

            <a href="{{ routes.all_products_collection_url }}" class="cart-summary__continue">
              Continue Shopping
            </a>

            <div class="cart-summary__trust">
              <div class="cart-summary__trust-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                <span>Secure Checkout</span>
              </div>
              <div class="cart-summary__trust-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
                <span>Free Shipping Over $50</span>
              </div>
            </div>
          </div>
        </div>

      </div>

    {% else %}
      
      <div class="cart-page__empty">
        <svg width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        <h2 class="cart-page__empty-title">Your cart is empty</h2>
        <p class="cart-page__empty-text">Add items to get started</p>
        {% render 'button',
          text: 'Start Shopping',
          url: routes.all_products_collection_url,
          variant: 'primary',
          size: 'lg'
        %}
      </div>

    {% endif %}

  </div>
</div>

<script>
function updateQuantity(line, quantity) {
  const formData = new FormData();
  formData.append('updates[]', quantity);
  formData.append('line', line);

  fetch('/cart/change.js', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    window.location.reload();
  })
  .catch(error => {
    console.error('Error updating cart:', error);
  });
}

// Auto-save cart note
const cartNote = document.getElementById('cart-note');
if (cartNote) {
  let timeout;
  cartNote.addEventListener('input', function() {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      const formData = new FormData();
      formData.append('note', this.value);
      
      fetch('/cart/update.js', {
        method: 'POST',
        body: formData
      });
    }, 1000);
  });
}
</script>
