{% comment %}
  Customer Addresses Section - Amazon-inspired Card Grid Layout
  
  Features:
  - Card grid layout (3 columns desktop, 2 tablet, 1 mobile)
  - Modal-based add/edit forms
  - Delete confirmation modal
  - Skeleton loading states
  - Client-side form validation
  - Pre-rendered province data for fast cascading selects
{% endcomment %}

{{ 'section-customer-addresses.css' | asset_url | stylesheet_tag }}

{%- comment -%} Pre-render country/province data {%- endcomment -%}
<script type="application/json" id="country-provinces-data">
  {
    {%- for country in all_countries -%}
      "{{ country.iso_code }}": {
        "name": {{ country.name | json }},
        "provinces": [
          {%- for province in country.provinces -%}
            { "code": {{ province.code | json }}, "name": {{ province.name | json }} }{% unless forloop.last %},{% endunless %}
          {%- endfor -%}
        ]
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  }
</script>

<div class="addresses-page addresses-page--loading" id="addresses-page">
  {%- comment -%} Skip Link {%- endcomment -%}
  <a href="#addresses-grid" class="addresses-page__skip-link">
    Skip to addresses
  </a>

  {%- comment -%} Breadcrumbs {%- endcomment -%}
  {%- assign breadcrumb_items = "Account," | append: routes.account_url | append: ";Addresses" | split: ";" -%}
  {% render 'breadcrumb', variant: 'account', items: breadcrumb_items %}

  {%- comment -%} Success/Error Alerts {%- endcomment -%}
  <div class="addresses-page__alert" id="addresses-alert" role="alert" aria-live="polite"></div>

  {%- comment -%} Page Header {%- endcomment -%}
  <header class="addresses-page__header">
    <h1 class="addresses-page__title">Your Addresses</h1>
    {% render 'button',
      text: 'Add Address',
      variant: 'primary',
      type: 'button',
      id: 'add-address-btn',
      icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>'
    %}
  </header>

  {%- comment -%} Skeleton Loading State {%- endcomment -%}
  <div class="addresses-page__loading" aria-busy="true" aria-label="Loading addresses">
    {% for i in (1..3) %}
      {% render 'skeleton', type: 'address-card' %}
    {% endfor %}
  </div>

  {%- comment -%} Address Grid {%- endcomment -%}
  <div class="addresses-page__grid" id="addresses-grid">
    {%- comment -%} Add Address Tile {%- endcomment -%}
    <button 
      type="button" 
      class="addresses-page__add-tile"
      data-modal-open="address-modal"
      data-action="add"
      aria-label="Add a new address"
    >
      <div class="addresses-page__add-tile-icon">
        {% render 'icon', name: 'plus', size: 24 %}
      </div>
      <span class="addresses-page__add-tile-text">Add Address</span>
    </button>

    {%- comment -%} Address Cards {%- endcomment -%}
    {% for address in customer.addresses %}
      {% render 'address-card', 
        address: address, 
        is_default: address.default,
        index: forloop.index 
      %}

      {%- comment -%} Hidden form for setting default address {%- endcomment -%}
      <form 
        method="post" 
        action="{{ routes.account_addresses_url }}/{{ address.id }}"
        id="set-default-form-{{ address.id }}"
        class="address-card__default-form"
      >
        <input type="hidden" name="form_type" value="customer_address">
        <input type="hidden" name="utf8" value="✓">
        <input type="hidden" name="_method" value="put">
        <input type="hidden" name="address[default]" value="1">
      </form>

      {%- comment -%} Hidden form for deleting address {%- endcomment -%}
      <form 
        method="post" 
        action="{{ routes.account_addresses_url }}/{{ address.id }}"
        id="delete-form-{{ address.id }}"
        class="address-card__default-form"
      >
        <input type="hidden" name="form_type" value="customer_address">
        <input type="hidden" name="utf8" value="✓">
        <input type="hidden" name="_method" value="delete">
      </form>
    {% endfor %}

    {%- comment -%} Empty State {%- endcomment -%}
    {% if customer.addresses.size == 0 %}
      <div class="addresses-page__empty">
        <svg class="addresses-page__empty-illustration" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
        <h2 class="addresses-page__empty-title">No addresses yet</h2>
        <p class="addresses-page__empty-description">
          Add your shipping addresses to make checkout faster and easier.
        </p>
        {% render 'button',
          text: 'Add your first address',
          variant: 'primary',
          type: 'button',
          class: 'addresses-page__empty-cta',
          id: 'add-first-address-btn'
        %}
      </div>
    {% endif %}
  </div>
</div>

{%- comment -%} =========================================
   Add/Edit Address Modal
   ========================================= {%- endcomment -%}
{% capture address_form_content %}
  <form 
    id="address-form" 
    method="post" 
    action="{{ routes.account_addresses_url }}"
    class="address-form"
    novalidate
  >
    <input type="hidden" name="form_type" value="customer_address">
    <input type="hidden" name="utf8" value="✓">
    <input type="hidden" id="address-form-method" name="_method" value="">
    <input type="hidden" id="address-form-id" name="address_id" value="">

    {%- comment -%} Error Message Container {%- endcomment -%}
    <div class="address-form__error" id="address-form-error" role="alert"></div>

    {%- comment -%} Name Row {%- endcomment -%}
    <div class="address-form__row">
      <div class="address-form__field">
        {% render 'input',
          name: 'address[first_name]',
          id: 'address-first-name',
          label: 'First Name',
          type: 'text',
          required: true,
          autocomplete: 'given-name'
        %}
      </div>
      <div class="address-form__field">
        {% render 'input',
          name: 'address[last_name]',
          id: 'address-last-name',
          label: 'Last Name',
          type: 'text',
          required: true,
          autocomplete: 'family-name'
        %}
      </div>
    </div>

    {%- comment -%} Company {%- endcomment -%}
    <div class="address-form__field">
      {% render 'input',
        name: 'address[company]',
        id: 'address-company',
        label: 'Company (Optional)',
        type: 'text',
        autocomplete: 'organization'
      %}
    </div>

    {%- comment -%} Address Line 1 {%- endcomment -%}
    <div class="address-form__field">
      {% render 'input',
        name: 'address[address1]',
        id: 'address-address1',
        label: 'Address',
        type: 'text',
        required: true,
        autocomplete: 'address-line1',
        placeholder: 'Street address'
      %}
    </div>

    {%- comment -%} Address Line 2 {%- endcomment -%}
    <div class="address-form__field">
      {% render 'input',
        name: 'address[address2]',
        id: 'address-address2',
        label: 'Apartment, suite, etc. (Optional)',
        type: 'text',
        autocomplete: 'address-line2'
      %}
    </div>

    {%- comment -%} City & Country Row {%- endcomment -%}
    <div class="address-form__row">
      <div class="address-form__field">
        {% render 'input',
          name: 'address[city]',
          id: 'address-city',
          label: 'City',
          type: 'text',
          required: true,
          autocomplete: 'address-level2'
        %}
      </div>
      <div class="address-form__field">
        <label for="address-country" class="select__label select__label--required">Country</label>
        <div class="select">
          <select 
            name="address[country]" 
            id="address-country" 
            class="select__native"
            required
            autocomplete="country"
          >
            {{ all_country_option_tags }}
          </select>
        </div>
      </div>
    </div>

    {%- comment -%} Province & Zip Row {%- endcomment -%}
    <div class="address-form__row">
      <div class="address-form__field" id="province-field">
        <label for="address-province" class="select__label">State/Province</label>
        <div class="select">
          <select 
            name="address[province]" 
            id="address-province" 
            class="select__native"
            autocomplete="address-level1"
          >
            <option value="">Select state/province</option>
          </select>
        </div>
      </div>
      <div class="address-form__field">
        {% render 'input',
          name: 'address[zip]',
          id: 'address-zip',
          label: 'ZIP/Postal Code',
          type: 'text',
          required: true,
          autocomplete: 'postal-code'
        %}
      </div>
    </div>

    {%- comment -%} Phone {%- endcomment -%}
    <div class="address-form__field">
      {% render 'input',
        name: 'address[phone]',
        id: 'address-phone',
        label: 'Phone (Optional)',
        type: 'tel',
        autocomplete: 'tel',
        hint: 'May be used for delivery updates'
      %}
    </div>

    {%- comment -%} Default Address Checkbox {%- endcomment -%}
    <div class="address-form__checkbox checkbox-wrapper" id="default-checkbox-wrapper">
      <input type="checkbox" name="address[default]" id="address-default" value="1" class="checkbox">
      <label for="address-default" class="checkbox-wrapper__label">Set as default address</label>
    </div>

    {%- comment -%} Form Actions {%- endcomment -%}
    <div class="address-form__actions">
      {% render 'button',
        text: 'Cancel',
        variant: 'outline',
        type: 'button',
        class: 'address-form__cancel'
      %}
      {% render 'button',
        text: 'Save Address',
        variant: 'primary',
        type: 'submit',
        id: 'address-form-submit'
      %}
    </div>
  </form>
{% endcapture %}

{% render 'modal',
  id: 'address-modal',
  title: 'Add a new address',
  content: address_form_content,
  size: 'medium'
%}

{%- comment -%} =========================================
   Delete Confirmation Modal
   ========================================= {%- endcomment -%}
{% capture delete_confirm_content %}
  <div class="delete-confirm">
    <svg class="delete-confirm__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <polyline points="3 6 5 6 21 6"></polyline>
      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
      <line x1="10" y1="11" x2="10" y2="17"></line>
      <line x1="14" y1="11" x2="14" y2="17"></line>
    </svg>
    <h3 class="delete-confirm__title">Remove this address?</h3>
    <p class="delete-confirm__address-name" id="delete-address-name"></p>
    <p class="delete-confirm__warning">
      This action cannot be undone. Any pending orders will still be shipped to this address.
    </p>
    <div class="delete-confirm__actions">
      {% render 'button',
        text: 'Cancel',
        variant: 'outline',
        type: 'button',
        class: 'delete-confirm__cancel'
      %}
      {% render 'button',
        text: 'Remove Address',
        variant: 'danger',
        type: 'button',
        id: 'confirm-delete-btn'
      %}
    </div>
  </div>
  <input type="hidden" id="delete-address-id" value="">
{% endcapture %}

{% render 'modal',
  id: 'delete-confirm-modal',
  title: '',
  content: delete_confirm_content,
  size: 'small'
%}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    if (typeof initAddresses === 'function') {
      initAddresses();
    }
  });
</script>

{% schema %}
{
  "name": "Customer Addresses",
  "settings": []
}
{% endschema %}
