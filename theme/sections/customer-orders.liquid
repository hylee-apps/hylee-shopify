{% comment %}
  Customer Orders Section
  Amazon-style order history with search, tabs, and filtering
{% endcomment %}

{{ 'section-customer-orders.css' | asset_url | stylesheet_tag }}

<div class="customer-orders">
  <div class="customer-orders__container">
    {%- comment -%} Skip Link for accessibility {%- endcomment -%}
    <a href="#orders-list" class="visually-hidden visually-hidden--focusable">
      Skip to order list
    </a>

    {%- comment -%} Breadcrumbs {%- endcomment -%}
    {%- assign breadcrumb_items = "Your Account," | append: routes.account_url | append: ";Your Orders" | split: ";" -%}
    {% render 'breadcrumb', variant: 'account', items: breadcrumb_items %}

    {%- comment -%} Header with Search {%- endcomment -%}
    <div class="customer-orders__header">
      <h1 class="customer-orders__title">Your Orders</h1>
      <div class="customer-orders__search-container">
        <form class="customer-orders__search-form" role="search" data-orders-search-form>
          <label for="orders-search" class="visually-hidden">Search your orders</label>
          <input
            type="search"
            id="orders-search"
            class="customer-orders__search-input"
            placeholder="Search all orders"
            aria-label="Search all orders"
            data-orders-search
          >
          <button type="button" class="customer-orders__search-btn" aria-label="Search orders" data-orders-search-btn>
            {% render 'icon', name: 'search', size: 16 %}
            Search Orders
          </button>
        </form>
      </div>
    </div>

    {%- comment -%} Tab Navigation {%- endcomment -%}
    <div class="customer-orders__nav" role="tablist" aria-label="Order filters">
      <button 
        class="customer-orders__nav-item customer-orders__nav-item--active" 
        role="tab" 
        aria-selected="true"
        aria-controls="orders-panel-all"
        id="orders-tab-all"
        data-orders-tab="all"
      >
        Orders
      </button>
      <button 
        class="customer-orders__nav-item" 
        role="tab" 
        aria-selected="false"
        aria-controls="orders-panel-buy-again"
        id="orders-tab-buy-again"
        data-orders-tab="buy-again"
      >
        Buy Again
      </button>
      <button 
        class="customer-orders__nav-item" 
        role="tab" 
        aria-selected="false"
        aria-controls="orders-panel-not-shipped"
        id="orders-tab-not-shipped"
        data-orders-tab="not-shipped"
      >
        Not Yet Shipped
      </button>
      <button 
        class="customer-orders__nav-item" 
        role="tab" 
        aria-selected="false"
        aria-controls="orders-panel-digital"
        id="orders-tab-digital"
        data-orders-tab="digital"
      >
        Digital Orders
      </button>
    </div>

    {%- comment -%} Filter Row {%- endcomment -%}
    <div class="customer-orders__filter-row">
      <span class="customer-orders__order-count" data-orders-count>
        {{ customer.orders_count }} order{% if customer.orders_count != 1 %}s{% endif %}
      </span>
      <div class="customer-orders__time-filter">
        <label for="orders-time-filter" class="visually-hidden">Filter by time period</label>
        <select id="orders-time-filter" class="customer-orders__time-select" data-orders-time-filter>
          <option value="30">past 30 days</option>
          <option value="90">past 3 months</option>
          <option value="180" selected>past 6 months</option>
          <option value="365">past year</option>
          <option value="all">all time</option>
        </select>
      </div>
    </div>

    {%- comment -%} Skeleton Loading Placeholder {%- endcomment -%}
    <div class="customer-orders__skeleton" data-orders-skeleton hidden aria-hidden="true">
      {% for i in (1..3) %}
        {% render 'skeleton', type: 'order-card' %}
      {% endfor %}
    </div>

    {%- comment -%} Orders Panel - All Orders {%- endcomment -%}
    <div 
      class="customer-orders__panel customer-orders__panel--active" 
      role="tabpanel" 
      id="orders-panel-all"
      aria-labelledby="orders-tab-all"
      data-orders-panel="all"
    >
      {% paginate customer.orders by 10 %}
        <div class="customer-orders__list" id="orders-list" data-orders-list>
          {% for order in customer.orders %}
            <article 
              class="customer-orders__card" 
              data-order-card
              data-order-date="{{ order.created_at | date: '%s' }}"
              data-order-number="{{ order.name }}"
              data-order-status="{{ order.fulfillment_status | default: 'unfulfilled' }}"
              data-order-products="{% for item in order.line_items %}{{ item.title | downcase }}{% unless forloop.last %},{% endunless %}{% endfor %}"
              data-order-has-digital="{% assign has_digital = false %}{% for item in order.line_items %}{% if item.product.tags contains 'digital' %}{% assign has_digital = true %}{% endif %}{% endfor %}{{ has_digital }}"
            >
              <header class="customer-orders__card-header">
                <div class="customer-orders__card-meta">
                  <div class="customer-orders__card-meta-item">
                    <span class="customer-orders__card-meta-label">ORDER PLACED</span>
                    <span class="customer-orders__card-meta-value">{{ order.created_at | date: '%B %d, %Y' }}</span>
                  </div>
                  <div class="customer-orders__card-meta-item">
                    <span class="customer-orders__card-meta-label">TOTAL</span>
                    <span class="customer-orders__card-meta-value">{{ order.total_price | money }}</span>
                  </div>
                  <div class="customer-orders__card-meta-item">
                    <span class="customer-orders__card-meta-label">SHIP TO</span>
                    <span class="customer-orders__card-meta-value">
                      {% if order.shipping_address %}
                        {{ order.shipping_address.name }}
                      {% else %}
                        {{ customer.name }}
                      {% endif %}
                    </span>
                  </div>
                </div>
                <div class="customer-orders__card-actions-header">
                  <span class="customer-orders__card-order-number">ORDER # {{ order.name }}</span>
                  <a href="{{ order.customer_url }}" class="customer-orders__card-link">View order details</a>
                </div>
              </header>

              <div class="customer-orders__card-body">
                <div class="customer-orders__delivery-status">
                  {% case order.fulfillment_status %}
                    {% when 'fulfilled' %}
                      {%- capture icon_html -%}{% render 'icon', name: 'check-circle', size: 16 %}{%- endcapture -%}
                      {% render 'badge', text: 'Delivered', variant: 'success', icon: icon_html %}
                    {% when 'partial' %}
                      {%- capture icon_html -%}{% render 'icon', name: 'truck', size: 16 %}{%- endcapture -%}
                      {% render 'badge', text: 'Partially Shipped', variant: 'info', icon: icon_html %}
                    {% else %}
                      {%- capture icon_html -%}{% render 'icon', name: 'clock', size: 16 %}{%- endcapture -%}
                      {% render 'badge', text: 'Processing', variant: 'warning', icon: icon_html %}
                  {% endcase %}
                  {% if order.fulfillment_status == 'fulfilled' %}
                    <span class="customer-orders__delivery-date">{{ order.updated_at | date: '%B %d, %Y' }}</span>
                  {% endif %}
                </div>

                <div class="customer-orders__items">
                  {% for item in order.line_items %}
                    <div class="customer-orders__item">
                      <div class="customer-orders__item-image-wrapper">
                        {% if item.image %}
                          <img 
                            src="{{ item.image | image_url: width: 120 }}" 
                            alt="{{ item.title }}" 
                            class="customer-orders__item-image"
                            width="120"
                            height="120"
                            loading="lazy"
                          >
                        {% else %}
                          <div class="customer-orders__item-image-placeholder" aria-hidden="true">
                            {% render 'icon', name: 'package', size: 40 %}
                          </div>
                        {% endif %}
                      </div>
                      <div class="customer-orders__item-details">
                        {%- assign item_url = item.product.url | default: item.url -%}
                        {% if item_url != blank %}
                          <a href="{{ item_url }}" class="customer-orders__item-title">{{ item.title }}</a>
                        {% else %}
                          <span class="customer-orders__item-title">{{ item.title }}</span>
                        {% endif %}
                        {% if item.variant.title != 'Default Title' %}
                          <p class="customer-orders__item-variant">{{ item.variant.title }}</p>
                        {% endif %}
                        <p class="customer-orders__item-quantity">Qty: {{ item.quantity }}</p>
                        <div class="customer-orders__item-actions">
                          {%- capture cart_icon -%}{% render 'icon', name: 'shopping-cart', size: 16 %}{%- endcapture -%}
                          <button 
                            type="button" 
                            class="btn btn--primary btn--sm customer-orders__item-btn"
                            data-buy-again
                            data-variant-id="{{ item.variant_id }}"
                            data-quantity="{{ item.quantity }}"
                            data-product-name="{{ item.title | escape }}"
                            aria-label="Add {{ item.title | escape }} to cart"
                          >
                            {{ cart_icon }}
                            <span>Buy it again</span>
                          </button>
                          {% if item_url != blank %}
                            {% render 'button', text: 'View your item', url: item_url, variant: 'outline', size: 'sm', class: 'customer-orders__item-btn' %}
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </article>
          {% else %}
            <div class="customer-orders__empty-state">
              {% render 'icon', name: 'package', size: 64 %}
              <p>You haven't placed any orders yet</p>
              {% render 'button', text: 'Start Shopping', url: routes.all_products_collection_url, variant: 'primary', class: 'customer-orders__empty-state-btn' %}
            </div>
          {% endfor %}
        </div>

        {% if paginate.pages > 1 %}
          <nav class="customer-orders__pagination" aria-label="Orders pagination">
            {{ paginate | default_pagination }}
          </nav>
        {% endif %}
      {% endpaginate %}
    </div>

    {%- comment -%} Buy Again Panel {%- endcomment -%}
    <div 
      class="customer-orders__panel" 
      role="tabpanel" 
      id="orders-panel-buy-again"
      aria-labelledby="orders-tab-buy-again"
      data-orders-panel="buy-again"
      hidden
    >
      <div class="customer-orders__buy-again-grid">
        {% assign seen_handles = '' %}
        {% assign product_count = 0 %}
        {% for order in customer.orders %}
          {% for item in order.line_items %}
            {% unless seen_handles contains item.product.handle %}
              {% assign seen_handles = seen_handles | append: item.product.handle | append: ',' %}
              {% assign product_count = product_count | plus: 1 %}
              {%- assign buy_again_url = item.product.url | default: item.url -%}
              <div class="customer-orders__buy-again-item" data-product-handle="{{ item.product.handle }}">
                <a href="{{ buy_again_url }}" class="customer-orders__buy-again-image-link">
                  {% if item.image %}
                    <img 
                      src="{{ item.image | image_url: width: 180 }}" 
                      alt="{{ item.title }}" 
                      class="customer-orders__buy-again-image"
                      width="180"
                      height="180"
                      loading="lazy"
                    >
                  {% else %}
                    <div class="customer-orders__buy-again-placeholder" aria-hidden="true">
                      {% render 'icon', name: 'package', size: 48 %}
                    </div>
                  {% endif %}
                </a>
                <div class="customer-orders__buy-again-details">
                  <a href="{{ buy_again_url }}" class="customer-orders__buy-again-title">{{ item.product.title }}</a>
                  <p class="customer-orders__buy-again-price">{{ item.product.price | money }}</p>
                  {% render 'button', text: 'View Product', url: buy_again_url, variant: 'primary', size: 'sm', class: 'customer-orders__item-btn' %}
                </div>
              </div>
            {% endunless %}
          {% endfor %}
        {% endfor %}
        {% if product_count == 0 %}
          <div class="customer-orders__empty-state">
            {% render 'icon', name: 'shopping-cart', size: 64 %}
            <p>No products to buy again</p>
            {% render 'button', text: 'Browse Products', url: routes.all_products_collection_url, variant: 'primary', class: 'customer-orders__empty-state-btn' %}
          </div>
        {% endif %}
      </div>
    </div>

    {%- comment -%} Not Yet Shipped Panel {%- endcomment -%}
    <div 
      class="customer-orders__panel" 
      role="tabpanel" 
      id="orders-panel-not-shipped"
      aria-labelledby="orders-tab-not-shipped"
      data-orders-panel="not-shipped"
      hidden
    >
      <div class="customer-orders__list" data-not-shipped-list>
        {% assign has_unshipped = false %}
        {% for order in customer.orders %}
          {% if order.fulfillment_status != 'fulfilled' %}
            {% assign has_unshipped = true %}
            <article class="customer-orders__card" data-order-card>
              <header class="customer-orders__card-header">
                <div class="customer-orders__card-meta">
                  <div class="customer-orders__card-meta-item">
                    <span class="customer-orders__card-meta-label">ORDER PLACED</span>
                    <span class="customer-orders__card-meta-value">{{ order.created_at | date: '%B %d, %Y' }}</span>
                  </div>
                  <div class="customer-orders__card-meta-item">
                    <span class="customer-orders__card-meta-label">TOTAL</span>
                    <span class="customer-orders__card-meta-value">{{ order.total_price | money }}</span>
                  </div>
                  <div class="customer-orders__card-meta-item">
                    <span class="customer-orders__card-meta-label">SHIP TO</span>
                    <span class="customer-orders__card-meta-value">
                      {% if order.shipping_address %}
                        {{ order.shipping_address.name }}
                      {% else %}
                        {{ customer.name }}
                      {% endif %}
                    </span>
                  </div>
                </div>
                <div class="customer-orders__card-actions-header">
                  <span class="customer-orders__card-order-number">ORDER # {{ order.name }}</span>
                  <a href="{{ order.customer_url }}" class="customer-orders__card-link">View order details</a>
                </div>
              </header>

              <div class="customer-orders__card-body">
                <div class="customer-orders__delivery-status">
                  {% if order.fulfillment_status == 'partial' %}
                    {%- capture icon_html -%}{% render 'icon', name: 'truck', size: 16 %}{%- endcapture -%}
                    {% render 'badge', text: 'Partially Shipped', variant: 'info', icon: icon_html %}
                  {% else %}
                    {%- capture icon_html -%}{% render 'icon', name: 'clock', size: 16 %}{%- endcapture -%}
                    {% render 'badge', text: 'Processing', variant: 'warning', icon: icon_html %}
                  {% endif %}
                </div>

                <div class="customer-orders__items">
                  {% for item in order.line_items %}
                    <div class="customer-orders__item">
                      <div class="customer-orders__item-image-wrapper">
                        {% if item.image %}
                          <img 
                            src="{{ item.image | image_url: width: 120 }}" 
                            alt="{{ item.title }}" 
                            class="customer-orders__item-image"
                            width="120"
                            height="120"
                            loading="lazy"
                          >
                        {% else %}
                          <div class="customer-orders__item-image-placeholder" aria-hidden="true">
                            {% render 'icon', name: 'package', size: 40 %}
                          </div>
                        {% endif %}
                      </div>
                      <div class="customer-orders__item-details">
                        {%- assign unshipped_item_url = item.product.url | default: item.url -%}
                        {% if unshipped_item_url != blank %}
                          <a href="{{ unshipped_item_url }}" class="customer-orders__item-title">{{ item.title }}</a>
                        {% else %}
                          <span class="customer-orders__item-title">{{ item.title }}</span>
                        {% endif %}
                        {% if item.variant.title != 'Default Title' %}
                          <p class="customer-orders__item-variant">{{ item.variant.title }}</p>
                        {% endif %}
                        <p class="customer-orders__item-quantity">Qty: {{ item.quantity }}</p>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </article>
          {% endif %}
        {% endfor %}
        {% unless has_unshipped %}
          <div class="customer-orders__empty-state">
            {% render 'icon', name: 'check-circle', size: 64 %}
            <p>All orders have been shipped!</p>
            {% render 'button', text: 'Continue Shopping', url: routes.all_products_collection_url, variant: 'primary', class: 'customer-orders__empty-state-btn' %}
          </div>
        {% endunless %}
      </div>
    </div>

    {%- comment -%} Digital Orders Panel {%- endcomment -%}
    <div 
      class="customer-orders__panel" 
      role="tabpanel" 
      id="orders-panel-digital"
      aria-labelledby="orders-tab-digital"
      data-orders-panel="digital"
      hidden
    >
      <div class="customer-orders__list" data-digital-list>
        {% assign has_digital = false %}
        {% for order in customer.orders %}
          {% assign order_has_digital = false %}
          {% for item in order.line_items %}
            {% if item.product.tags contains 'digital' %}
              {% assign order_has_digital = true %}
              {% assign has_digital = true %}
            {% endif %}
          {% endfor %}
          {% if order_has_digital %}
            <article class="customer-orders__card" data-order-card>
              <header class="customer-orders__card-header">
                <div class="customer-orders__card-meta">
                  <div class="customer-orders__card-meta-item">
                    <span class="customer-orders__card-meta-label">ORDER PLACED</span>
                    <span class="customer-orders__card-meta-value">{{ order.created_at | date: '%B %d, %Y' }}</span>
                  </div>
                  <div class="customer-orders__card-meta-item">
                    <span class="customer-orders__card-meta-label">TOTAL</span>
                    <span class="customer-orders__card-meta-value">{{ order.total_price | money }}</span>
                  </div>
                </div>
                <div class="customer-orders__card-actions-header">
                  <span class="customer-orders__card-order-number">ORDER # {{ order.name }}</span>
                  <a href="{{ order.customer_url }}" class="customer-orders__card-link">View order details</a>
                </div>
              </header>

              <div class="customer-orders__card-body">
                <div class="customer-orders__delivery-status">
                  {%- capture icon_html -%}{% render 'icon', name: 'download', size: 16 %}{%- endcapture -%}
                  {% render 'badge', text: 'Digital Product', variant: 'secondary', icon: icon_html %}
                </div>

                <div class="customer-orders__items">
                  {% for item in order.line_items %}
                    {% if item.product.tags contains 'digital' %}
                      <div class="customer-orders__item">
                        <div class="customer-orders__item-image-wrapper">
                          {% if item.image %}
                            <img 
                              src="{{ item.image | image_url: width: 120 }}" 
                              alt="{{ item.title }}" 
                              class="customer-orders__item-image"
                              width="120"
                              height="120"
                              loading="lazy"
                            >
                          {% else %}
                            <div class="customer-orders__item-image-placeholder" aria-hidden="true">
                              {% render 'icon', name: 'download', size: 40 %}
                            </div>
                          {% endif %}
                        </div>
                        <div class="customer-orders__item-details">
                          {%- assign digital_item_url = item.product.url | default: item.url -%}
                          {% if digital_item_url != blank %}
                            <a href="{{ digital_item_url }}" class="customer-orders__item-title">{{ item.title }}</a>
                          {% else %}
                            <span class="customer-orders__item-title">{{ item.title }}</span>
                          {% endif %}
                          {% if item.variant.title != 'Default Title' %}
                            <p class="customer-orders__item-variant">{{ item.variant.title }}</p>
                          {% endif %}
                          <div class="customer-orders__item-actions">
                            {% if digital_item_url != blank %}
                              {% render 'button', text: 'View Product', url: digital_item_url, variant: 'outline', size: 'sm', class: 'customer-orders__item-btn' %}
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
            </article>
          {% endif %}
        {% endfor %}
        {% unless has_digital %}
          <div class="customer-orders__empty-state">
            {% render 'icon', name: 'download', size: 64 %}
            <p>No digital orders</p>
            {% render 'button', text: 'Browse Products', url: routes.all_products_collection_url, variant: 'primary', class: 'customer-orders__empty-state-btn' %}
          </div>
        {% endunless %}
      </div>
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Customer Orders",
  "settings": []
}
{% endschema %}
