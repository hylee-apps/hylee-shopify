{% comment %}
  Order Detail Section
  Comprehensive order tracking matching React OrderDetail component
{% endcomment %}

{{ 'section-order-detail.css' | asset_url | stylesheet_tag }}
{{ 'section-customer-orders.css' | asset_url | stylesheet_tag }}

<div class="order-detail"
     data-order-name="{{ order.name }}"
     data-order-id="{{ order.id }}"
     data-customer-email="{{ order.email | default: customer.email }}"
     data-order-date="{{ order.created_at | date: '%B %d, %Y' }}"
     data-order-total="{{ order.total_price | money }}">
  {%- comment %-%} Skip Link for accessibility {%- endcomment -%}
  <a href="#order-items" class="visually-hidden visually-hidden--focusable">
    Skip to order items
  </a>

  <div class="order-detail__container">
    {%- comment %-%} Breadcrumbs {%- endcomment -%}
    {%- capture order_label -%}Order {{ order.name }}{%- endcapture -%}
    {%- assign breadcrumb_items = "Your Account," | append: routes.account_url | append: ";Your Orders,/pages/orders;" | append: order_label | split: ";" -%}
    {% render 'breadcrumb', variant: 'account', items: breadcrumb_items %}

    {%- comment %-%} Page Title {%- endcomment -%}
    <div class="order-detail__page-header">
      <h1 class="order-detail__page-title">Order Tracking</h1>
      <p class="order-detail__page-subtitle">Order {{ order.name }} • Placed on {{ order.created_at | date: "%B %d, %Y" }}</p>
    </div>

    <div class="order-detail__grid">
      {%- comment %-%} Main Content {%- endcomment -%}
      <div class="order-detail__main">
        {%- comment %-%} Tracking Status {%- endcomment -%}
        <div class="order-detail__card">
          <div class="order-detail__status-header">
            <div>
              <h2 class="order-detail__card-title">Delivery Status</h2>
              <p class="order-detail__status-subtitle">
                {% if order.fulfillments.size > 0 %}
                  Estimated delivery: {{ order.fulfillments.first.created_at | date: "%s" | plus: 604800 | date: "%B %d, %Y" }}
                {% else %}
                  Processing your order
                {% endif %}
              </p>
            </div>
            {% if order.fulfillments.size > 0 and order.fulfillments.first.tracking_number %}
              <div class="order-detail__tracking-number-wrapper">
                <p class="order-detail__label">Tracking #</p>
                <p class="order-detail__tracking-number">{{ order.fulfillments.first.tracking_number }}</p>
              </div>
            {% endif %}
          </div>

          {%- comment %-%} Progress Bar {%- endcomment -%}
          <div class="order-detail__progress-section">
            <div class="order-detail__progress-bar">
              <div class="order-detail__progress-fill" style="width: {% if order.cancelled %}0{% elsif order.fulfillments.size > 0 %}75{% else %}25{% endif %}%"></div>
            </div>
            <div class="order-detail__progress-stages">
              <div class="order-detail__stage order-detail__stage--active">
                <div class="order-detail__stage-icon order-detail__stage-icon--active">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                  </svg>
                </div>
                <span class="order-detail__stage-label order-detail__stage-label--active">Processing</span>
              </div>

              <div class="order-detail__stage {% if order.fulfillments.size > 0 %}order-detail__stage--active{% endif %}">
                <div class="order-detail__stage-icon {% if order.fulfillments.size > 0 %}order-detail__stage-icon--active{% endif %}">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                  </svg>
                </div>
                <span class="order-detail__stage-label {% if order.fulfillments.size > 0 %}order-detail__stage-label--active{% endif %}">Shipped</span>
              </div>

              <div class="order-detail__stage">
                <div class="order-detail__stage-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                </div>
                <span class="order-detail__stage-label">In Transit</span>
              </div>

              <div class="order-detail__stage">
                <div class="order-detail__stage-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <span class="order-detail__stage-label">Delivered</span>
              </div>
            </div>
          </div>

          {%- comment %-%} Current Status Card {%- endcomment -%}
          <div class="order-detail__current-status" role="status" aria-label="Current order status">
            <svg class="order-detail__status-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
            <div class="order-detail__status-content">
              <h3 class="order-detail__status-title">
                {% if order.cancelled %}
                  Order Cancelled
                {% elsif order.fulfillments.size > 0 %}
                  Order Shipped
                {% else %}
                  Order Processing
                {% endif %}
              </h3>
              <p class="order-detail__status-description">
                {% if order.cancelled %}
                  This order has been cancelled.
                {% elsif order.fulfillments.size > 0 %}
                  Your order is on its way to you!
                {% else %}
                  We're preparing your order for shipment.
                {% endif %}
              </p>
              <p class="order-detail__status-location">
                {{ order.shipping_address.city }}, {{ order.shipping_address.province_code }} • {{ order.created_at | date: "%B %d, %Y" }}
              </p>
            </div>
          </div>

          {%- comment %-%} Carrier Info {%- endcomment -%}
          {% if order.fulfillments.size > 0 %}
            <div class="order-detail__carrier-info">
              <div class="order-detail__carrier-content">
                <div class="order-detail__carrier-icon">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                  </svg>
                </div>
                <div>
                  <p class="order-detail__label">Shipped via</p>
                  <p class="order-detail__carrier-name">{{ order.fulfillments.first.tracking_company | default: "Standard Shipping" }}</p>
                </div>
              </div>
              {% if order.fulfillments.first.tracking_url %}
                <a href="{{ order.fulfillments.first.tracking_url }}" target="_blank" class="order-detail__btn order-detail__btn--outline order-detail__btn--small">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                  </svg>
                  Track on Carrier Site
                </a>
              {% endif %}
            </div>
          {% endif %}
        </div>

        {%- comment %-%} Tracking Timeline {%- endcomment -%}
        {% if order.fulfillments.size > 0 %}
          <div class="order-detail__card">
            <h2 class="order-detail__card-title">Tracking History</h2>
            <div class="order-detail__timeline">
              <div class="order-detail__timeline-item">
                <div class="order-detail__timeline-dot order-detail__timeline-dot--active"></div>
                <div class="order-detail__timeline-content">
                  <div class="order-detail__timeline-header">
                    <h4 class="order-detail__timeline-title">Order Shipped</h4>
                    <span class="order-detail__timeline-time">{{ order.fulfillments.first.created_at | date: "%I:%M %p" }}</span>
                  </div>
                  <p class="order-detail__timeline-description">Package picked up by carrier</p>
                  <p class="order-detail__timeline-location">{{ order.shipping_address.city }}, {{ order.shipping_address.province_code }} • {{ order.fulfillments.first.created_at | date: "%B %d, %Y" }}</p>
                </div>
              </div>

              <div class="order-detail__timeline-item">
                <div class="order-detail__timeline-dot"></div>
                <div class="order-detail__timeline-content">
                  <div class="order-detail__timeline-header">
                    <h4 class="order-detail__timeline-title">Order Confirmed</h4>
                    <span class="order-detail__timeline-time">{{ order.created_at | date: "%I:%M %p" }}</span>
                  </div>
                  <p class="order-detail__timeline-description">Order placed successfully</p>
                  <p class="order-detail__timeline-location">Online • {{ order.created_at | date: "%B %d, %Y" }}</p>
                </div>
              </div>
            </div>
          </div>
        {% endif %}

        {%- comment %-%} Order Items {%- endcomment -%}
        <div class="order-detail__card" id="order-items">
          <h2 class="order-detail__card-title">Items in This Order</h2>
          <div class="order-detail__items" role="list">
            {% for line_item in order.line_items %}
              <div class="order-detail__item">
                <div class="order-detail__item-image">
                  {% if line_item.image %}
                    <img src="{{ line_item.image | image_url: width: 80 }}" alt="{{ line_item.title }}" loading="lazy">
                  {% else %}
                    <div class="order-detail__item-placeholder"></div>
                  {% endif %}
                </div>
                <div class="order-detail__item-details">
                  <h4 class="order-detail__item-name">{{ line_item.title }}</h4>
                  <p class="order-detail__item-variant">{{ line_item.variant_title }}</p>
                  <div class="order-detail__item-footer">
                    <span class="order-detail__item-quantity">Qty: {{ line_item.quantity }}</span>
                    <span class="order-detail__item-price">{{ line_item.final_line_price | money }}</span>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          {%- comment %-%} Reorder Button {%- endcomment -%}
          <div class="order-detail__reorder">
            {%- capture cart_icon -%}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
            {%- endcapture -%}
            {%- capture reorder_items -%}
              [{%- for line_item in order.line_items -%}{"variantId":"{{ line_item.variant_id }}","quantity":{{ line_item.quantity }}}{%- unless forloop.last -%},{%- endunless -%}{%- endfor -%}]
            {%- endcapture -%}
            <button 
              type="button" 
              class="btn btn--outline btn--full-width order-detail__btn"
              data-reorder-all
              data-items='{{ reorder_items }}'
              aria-label="Add all items from this order to cart"
            >
              {{ cart_icon }}
              <span>Reorder These Items</span>
            </button>
          </div>
        </div>
      </div>

      {%- comment %-%} Sidebar {%- endcomment -%}
      <div class="order-detail__sidebar">
        {%- comment %-%} Order Summary {%- endcomment -%}
        <div class="order-detail__card">
          <h3 class="order-detail__sidebar-title">Order Summary</h3>

          <div class="order-detail__summary">
            <div class="order-detail__summary-row">
              <span class="order-detail__summary-label">Subtotal</span>
              <span class="order-detail__summary-value">{{ order.subtotal_price | money }}</span>
            </div>
            <div class="order-detail__summary-row">
              <span class="order-detail__summary-label">Shipping</span>
              <span class="order-detail__summary-value">{{ order.shipping_price | money }}</span>
            </div>
            <div class="order-detail__summary-row">
              <span class="order-detail__summary-label">Tax</span>
              <span class="order-detail__summary-value">{{ order.tax_price | money }}</span>
            </div>
          </div>

          <div class="order-detail__divider"></div>

          <div class="order-detail__summary-total">
            <span class="order-detail__summary-label">Total</span>
            <span class="order-detail__total-price">{{ order.total_price | money }}</span>
          </div>

          {%- comment %-%} Shipping Address {%- endcomment -%}
          <div class="order-detail__address-section">
            <h4 class="order-detail__address-title">Shipping To</h4>
            <div class="order-detail__address">
              <p>{{ order.shipping_address.name }}</p>
              <p>{{ order.shipping_address.address1 }}</p>
              {% if order.shipping_address.address2 != blank %}
                <p>{{ order.shipping_address.address2 }}</p>
              {% endif %}
              <p>{{ order.shipping_address.city }}, {{ order.shipping_address.province_code }} {{ order.shipping_address.zip }}</p>
            </div>
          </div>

          {%- comment %-%} Payment Method {%- endcomment -%}
          <div class="order-detail__address-section">
            <h4 class="order-detail__address-title">Payment</h4>
            <p class="order-detail__payment">
              {{ order.payment_details.credit_card_company | default: "Credit Card" }} ending in {{ order.payment_details.credit_card_last_four_digits | default: "****" }}
            </p>
          </div>

          <div class="order-detail__divider"></div>

          {%- comment %-%} Quick Actions {%- endcomment -%}
          <div class="order-detail__actions">
            {%- capture download_icon -%}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
            {%- endcapture -%}
            {%- capture email_icon -%}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
              </svg>
            {%- endcapture -%}
            <button type="button" class="btn btn--outline btn--sm btn--full-width order-detail__btn" data-download-invoice aria-label="Download invoice for order {{ order.name }}">
              {{ download_icon }}
              <span>Download Invoice</span>
            </button>
            <button type="button" class="btn btn--outline btn--sm btn--full-width order-detail__btn" data-email-receipt aria-label="Email receipt for order {{ order.name }}">
              {{ email_icon }}
              <span>Email Receipt</span>
            </button>
          </div>
        </div>

        {%- comment %-%} Need Help {%- endcomment -%}
        <div class="order-detail__card">
          <h3 class="order-detail__sidebar-title">Need Help?</h3>
          <div class="order-detail__help-actions">
            {%- capture warning_icon -%}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            {%- endcapture -%}
            <button type="button" class="btn btn--outline btn--sm btn--full-width order-detail__btn" data-report-issue>
              {{ warning_icon }}
              <span>Report an Issue</span>
            </button>
            {% render 'button', text: 'Contact Support', url: '/pages/contact', variant: 'outline', size: 'sm', full_width: true, class: 'order-detail__btn' %}
          </div>
        </div>

        {%- comment %-%} Create Account CTA (for guest orders) {%- endcomment -%}
        {% unless customer %}
          <div class="order-detail__cta-card">
            <h3 class="order-detail__cta-title">Save Your Preferences</h3>
            <p class="order-detail__cta-text">
              Create an account to easily track future orders and manage delivery preferences.
            </p>
            <a href="{{ routes.account_register_url }}" class="order-detail__btn order-detail__btn--primary order-detail__btn--small order-detail__btn--full">
              Create Account
            </a>
          </div>
        {% endunless %}
      </div>
    </div>
  </div>
</div>
